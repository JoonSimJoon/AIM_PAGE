'use client'

import { useState, useEffect } from 'react'
import { Button, Card, Text, Title, Subtitle, Loading, Modal } from '@/components/ui'

interface AboutSection {
  id: string
  type: string
  title: string
  content: string
  order: number
  isActive: boolean
}

interface AboutActivity {
  id: string
  title: string
  description: string
  icon: string
  color: string
  order: number
  isActive: boolean
}

interface AboutHistory {
  id: string
  year: number
  title: string
  description: string
  order: number
  isActive: boolean
}

interface AboutContact {
  id: string
  type: string
  label: string
  value: string
  order: number
  isActive: boolean
}

export default function AboutManagementPage() {
  const [activeTab, setActiveTab] = useState<'sections' | 'activities' | 'history' | 'contact'>('sections')
  const [sections, setSections] = useState<AboutSection[]>([])
  const [activities, setActivities] = useState<AboutActivity[]>([])
  const [history, setHistory] = useState<AboutHistory[]>([])
  const [contacts, setContacts] = useState<AboutContact[]>([])
  const [loading, setLoading] = useState(true)
  const [showModal, setShowModal] = useState(false)
  const [editingItem, setEditingItem] = useState<any>(null)
  const [formData, setFormData] = useState<{
    type?: string
    title?: string
    content?: string
    description?: string
    icon?: string
    color?: string
    year?: number
    label?: string
    value?: string
    order?: number
  }>({})
  const [notification, setNotification] = useState<{
    show: boolean
    type: 'success' | 'error'
    title: string
    message: string
  }>({
    show: false,
    type: 'success',
    title: '',
    message: ''
  })

  // í˜ì´ì§€ ì œëª© ì„¤ì •
  useEffect(() => {
    document.title = 'ì†Œê°œ ê´€ë¦¬ - AIM: AI Monsters'
  }, [])

  // ë°ì´í„° ë¡œë“œ
  const fetchData = async () => {
    try {
      const token = localStorage.getItem('token')
      const [sectionsRes, activitiesRes, historyRes, contactsRes] = await Promise.all([
        fetch('http://localhost:3001/api/content/about/sections/admin', {
          headers: { 'Authorization': `Bearer ${token}` }
        }),
        fetch('http://localhost:3001/api/content/about/activities/admin', {
          headers: { 'Authorization': `Bearer ${token}` }
        }),
        fetch('http://localhost:3001/api/content/about/history/admin', {
          headers: { 'Authorization': `Bearer ${token}` }
        }),
        fetch('http://localhost:3001/api/content/about/contact/admin', {
          headers: { 'Authorization': `Bearer ${token}` }
        })
      ])

      if (sectionsRes.ok) setSections(await sectionsRes.json())
      if (activitiesRes.ok) setActivities(await activitiesRes.json())
      if (historyRes.ok) setHistory(await historyRes.json())
      if (contactsRes.ok) setContacts(await contactsRes.json())
    } catch (error) {
      console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error)
      showNotification({
        show: true,
        type: 'error',
        title: 'ì˜¤ë¥˜',
        message: 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
      })
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchData()
  }, [])

  // ëª¨ë‹¬ ì—´ê¸°
  const openAddModal = () => {
    setEditingItem(null)
    setFormData({})
    setShowModal(true)
  }

  // ëª¨ë‹¬ ë‹«ê¸°
  const closeModal = () => {
    setShowModal(false)
    setEditingItem(null)
    setFormData({})
  }

  // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ í•¸ë“¤ëŸ¬

  // ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜
  const handleEdit = (item: any) => {
    setEditingItem(item)
    setFormData({ ...item })
    setShowModal(true)
  }

  // í¼ ì œì¶œ
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    try {
      const token = localStorage.getItem('token')
      const endpoint = getEndpoint()
      const method = editingItem ? 'PUT' : 'POST'
      const url = editingItem ? `${endpoint}/${editingItem.id}` : endpoint
      
      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(formData)
      })

      if (response.ok) {
        showNotification({
          show: true,
          type: 'success',
          title: 'ì„±ê³µ',
          message: editingItem ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.'
        })
        fetchData()
        closeModal()
      } else {
        const data = await response.json()
        showNotification({
          show: true,
          type: 'error',
          title: 'ì˜¤ë¥˜',
          message: data.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
        })
      }
    } catch (error) {
      console.error('ì €ì¥ ì˜¤ë¥˜:', error)
      showNotification({
        show: true,
        type: 'error',
        title: 'ì˜¤ë¥˜',
        message: 'ì„œë²„ì™€ì˜ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
      })
    }
  }

  // ì‚­ì œ
  const handleDelete = async (id: string) => {
    if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return

    try {
      const token = localStorage.getItem('token')
      const endpoint = getEndpoint()
      const response = await fetch(`${endpoint}/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      })

      if (response.ok) {
        showNotification({
          show: true,
          type: 'success',
          title: 'ì„±ê³µ',
          message: 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'
        })
        fetchData()
      } else {
        showNotification({
          show: true,
          type: 'error',
          title: 'ì˜¤ë¥˜',
          message: 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
        })
      }
    } catch (error) {
      console.error('ì‚­ì œ ì˜¤ë¥˜:', error)
      showNotification({
        show: true,
        type: 'error',
        title: 'ì˜¤ë¥˜',
        message: 'ì„œë²„ì™€ì˜ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
      })
    }
  }

  // ì—”ë“œí¬ì¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
  const getEndpoint = () => {
    switch (activeTab) {
      case 'sections': return 'http://localhost:3001/api/content/about/sections'
      case 'activities': return 'http://localhost:3001/api/content/about/activities'
      case 'history': return 'http://localhost:3001/api/content/about/history'
      case 'contact': return 'http://localhost:3001/api/content/about/contact'
      default: return ''
    }
  }

  // í˜„ì¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const getCurrentData = () => {
    switch (activeTab) {
      case 'sections': return sections
      case 'activities': return activities
      case 'history': return history
      case 'contact': return contacts
      default: return []
    }
  }

  // ì•Œë¦¼ í‘œì‹œ
  const showNotification = (notification: {
    show: boolean
    type: 'success' | 'error'
    title: string
    message: string
  }) => {
    setNotification(notification)
  }

  // ì•Œë¦¼ ìˆ¨ê¸°ê¸°
  const hideNotification = () => {
    setNotification(prev => ({ ...prev, show: false }))
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-black">
        <div className="flex justify-center items-center h-screen">
          <Loading text="ì†Œê°œ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..." size="lg" />
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-black">
      {/* í—¤ë” */}
      <div className="mb-8">
        <Title level={1} className="text-white mb-2">ì†Œê°œ ê´€ë¦¬</Title>
        <Subtitle className="text-gray-400">
          ì†Œê°œ í˜ì´ì§€ì˜ ê° ì„¹ì…˜ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </Subtitle>
      </div>

        {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
        <div className="mb-6">
          <div className="flex space-x-1 bg-gray-800 p-1 rounded-lg">
            {[
              { key: 'sections', label: 'ì†Œê°œ ì„¹ì…˜', icon: 'ğŸ“' },
              { key: 'activities', label: 'ì£¼ìš” í™œë™', icon: 'ğŸš€' },
              { key: 'history', label: 'ë™ì•„ë¦¬ ì—°í˜', icon: 'ğŸ“…' },
              { key: 'contact', label: 'ì—°ë½ì²˜', icon: 'ğŸ“' }
            ].map((tab) => (
            <button
                key={tab.key}
                onClick={() => setActiveTab(tab.key as any)}
                className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${
                  activeTab === tab.key
                    ? 'bg-cyan-500 text-black'
                    : 'text-gray-400 hover:text-white hover:bg-gray-700'
                }`}
              >
                {tab.icon} {tab.label}
            </button>
            ))}
          </div>
        </div>

        {/* ì•¡ì…˜ ë²„íŠ¼ */}
        <div className="mb-6">
          <Button onClick={openAddModal} variant="primary">
            ìƒˆ {activeTab === 'sections' ? 'ì„¹ì…˜' : activeTab === 'activities' ? 'í™œë™' : activeTab === 'history' ? 'ì—°í˜' : 'ì—°ë½ì²˜'} ì¶”ê°€
          </Button>
        </div>

        {/* ë°ì´í„° ëª©ë¡ */}
        <div className="space-y-4">
          {getCurrentData().length === 0 ? (
            <Card className="text-center py-12">
              <Text variant="secondary" size="lg">
                ë“±ë¡ëœ {activeTab === 'sections' ? 'ì„¹ì…˜' : activeTab === 'activities' ? 'í™œë™' : activeTab === 'history' ? 'ì—°í˜' : 'ì—°ë½ì²˜'}ì´ ì—†ìŠµë‹ˆë‹¤.
              </Text>
            </Card>
          ) : (
            getCurrentData().map((item: any) => (
              <Card key={item.id} className="p-6">
              <div className="flex justify-between items-start mb-4">
                <div className="flex-1">
                    <Title level={3} className="text-white mb-2">
                      {item.title || item.label}
                    </Title>
                    <Text variant="secondary" className="mb-2">
                      {item.content || item.description || item.value}
                    </Text>
                    {item.year && (
                      <Text variant="muted" size="sm" className="mb-1">
                        ì—°ë„: {item.year}
                      </Text>
                    )}
                    <Text variant="muted" size="sm">
                      ìˆœì„œ: {item.order}
                    </Text>
                  </div>
                  <div className="flex space-x-2 ml-4">
                    <Button 
                      onClick={() => handleEdit(item)} 
                      variant="ghost" 
                      size="sm"
                    >
                      ìˆ˜ì •
                    </Button>
                    <Button 
                      onClick={() => handleDelete(item.id)} 
                      variant="secondary" 
                      size="sm"
                    >
                      ì‚­ì œ
                    </Button>
              </div>
                </div>
              </Card>
          ))
        )}
      </div>

        {/* ëª¨ë‹¬ */}
        <Modal
          isOpen={showModal}
          onClose={closeModal}
          title={editingItem ? `${activeTab === 'sections' ? 'ì†Œê°œ ì„¹ì…˜' : activeTab === 'activities' ? 'ì£¼ìš” í™œë™' : activeTab === 'history' ? 'ë™ì•„ë¦¬ ì—°í˜' : 'ì—°ë½ì²˜'} ìˆ˜ì •` : `ìƒˆ ${activeTab === 'sections' ? 'ì†Œê°œ ì„¹ì…˜' : activeTab === 'activities' ? 'ì£¼ìš” í™œë™' : activeTab === 'history' ? 'ë™ì•„ë¦¬ ì—°í˜' : 'ì—°ë½ì²˜'} ì¶”ê°€`}
          onSubmit={handleSubmit}
          submitText={editingItem ? 'ìˆ˜ì •' : 'ìƒì„±'}
          maxWidth="4xl"
        >
                  {activeTab === 'sections' && (
                    <>
                      <div>
                        <label className="block text-sm font-medium text-white mb-2">íƒ€ì…</label>
                        <select
                          value={formData.type || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value }))}
                          className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                          required
                        >
                          <option value="">íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”</option>
                          <option value="intro">ì†Œê°œ</option>
                          <option value="activity">í™œë™</option>
                          <option value="history">ì—°í˜</option>
                          <option value="contact">ì—°ë½ì²˜</option>
                        </select>
                      </div>
              <div>
                        <label className="block text-sm font-medium text-white mb-2">ì œëª©</label>
                <input
                  type="text"
                          value={formData.title || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                          className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                  required
                />
              </div>
                  <div>
                        <label className="block text-sm font-medium text-white mb-2">ë‚´ìš©</label>
                        <textarea
                          value={formData.content || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, content: e.target.value }))}
                          className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                          rows={6}
                          required
                    />
                  </div>
                    </>
                  )}
                  
                  {activeTab === 'activities' && (
                    <>
                  <div>
                        <label className="block text-sm font-medium text-white mb-2">ì œëª©</label>
                    <input
                      type="text"
                          value={formData.title || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                          className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                          required
                    />
                  </div>
                  <div>
                        <label className="block text-sm font-medium text-white mb-2">ì„¤ëª…</label>
                        <textarea
                          value={formData.description || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                          className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                          rows={4}
                          required
                    />
                  </div>
                      <div className="grid grid-cols-2 gap-4">
                  <div>
                          <label className="block text-sm font-medium text-white mb-2">ì•„ì´ì½˜</label>
                    <input
                      type="text"
                            value={formData.icon || ''}
                            onChange={(e) => setFormData(prev => ({ ...prev, icon: e.target.value }))}
                            className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                            placeholder="ğŸ“š"
                      required
                    />
                  </div>
                  <div>
                          <label className="block text-sm font-medium text-white mb-2">ìƒ‰ìƒ</label>
                          <select
                            value={formData.color || ''}
                            onChange={(e) => setFormData(prev => ({ ...prev, color: e.target.value }))}
                            className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                            required
                          >
                            <option value="">ìƒ‰ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="cyan">cyan</option>
                            <option value="pink">pink</option>
                            <option value="yellow">yellow</option>
                            <option value="purple">purple</option>
                          </select>
                        </div>
                        </div>
                    </>
                  )}

                  {activeTab === 'history' && (
                    <>
                      <div>
                        <label className="block text-sm font-medium text-white mb-2">ì—°ë„</label>
                        <input
                          type="number"
                          value={formData.year || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, year: parseInt(e.target.value) }))}
                          className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                          required
                        />
                    </div>
                      <div>
                        <label className="block text-sm font-medium text-white mb-2">ì œëª©</label>
                        <input
                          type="text"
                          value={formData.title || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                          className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                          required
                        />
                  </div>
                      <div>
                        <label className="block text-sm font-medium text-white mb-2">ì„¤ëª…</label>
                        <textarea
                          value={formData.description || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                          className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                          rows={4}
                          required
                        />
                </div>
                    </>
                  )}

                  {activeTab === 'contact' && (
                    <>
                      <div>
                        <label className="block text-sm font-medium text-white mb-2">íƒ€ì…</label>
                        <select
                          value={formData.type || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value }))}
                          className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                          required
                        >
                          <option value="">íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”</option>
                          <option value="email">ì´ë©”ì¼</option>
                          <option value="github">GitHub</option>
                          <option value="instagram">Instagram</option>
                          <option value="phone">ì „í™”ë²ˆí˜¸</option>
                        </select>
              </div>
                <div>
                        <label className="block text-sm font-medium text-white mb-2">ë¼ë²¨</label>
                  <input
                          type="text"
                          value={formData.label || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, label: e.target.value }))}
                          className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                    required
                  />
                </div>
                <div>
                        <label className="block text-sm font-medium text-white mb-2">ê°’</label>
                  <input
                          type="text"
                          value={formData.value || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, value: e.target.value }))}
                          className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                    required
                  />
                </div>
                    </>
                  )}

              <div>
                    <label className="block text-sm font-medium text-white mb-2">ìˆœì„œ</label>
                <input
                      type="number"
                      value={formData.order || 0}
                      onChange={(e) => setFormData(prev => ({ ...prev, order: parseInt(e.target.value) }))}
                      className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                />
              </div>


        {/* ì•Œë¦¼ */}
      {notification.show && (
          <div className="fixed top-4 right-4 z-50 bg-gray-800 border border-gray-600 rounded-lg p-4 max-w-sm">
            <div className="flex items-start">
              <div className="flex-1">
                <Title level={4} className="text-white mb-1">
                {notification.title}
                </Title>
                <Text variant="secondary" size="sm">
                  {notification.message}
                </Text>
            </div>
              <Button onClick={hideNotification} variant="ghost" size="sm" className="ml-2">
                âœ•
              </Button>
          </div>
        </div>
      )}
    </div>
  )
}